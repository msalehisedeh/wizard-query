!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs/operators"),require("rxjs"),require("xmldom"),require("@angular/common"),require("@angular/common/http"),require("@angular/core")):"function"==typeof define&&define.amd?define("wizard-query",["exports","rxjs/operators","rxjs","xmldom","@angular/common","@angular/common/http","@angular/core"],t):t(e["wizard-query"]={},e.rxjs.operators,e.rxjs,e.xmldom,e.ng.common,e.ng.common.http,e.ng.core)}(this,function(e,s,a,u,t,c,n){"use strict";var r=function(){function e(e){this.http=e,this.SERVICE_PATH="",this.logEnabled=!1}return e.prototype._normalize=function(t){var n=this;if(t instanceof Array){var r=[];t.map(function(e){r.push(n._normalize(e))}),t=r}else if("object"==typeof t){var e=Object.keys(t);if(1!==e.length||t[e[0]]instanceof Array){var i={};e.map(function(e){i[e]=n._normalize(t[e])}),t=i}else if(t["#text"])t=t["#text"];else if(t["#cdata-section"]){t=t["#cdata-section"];try{var o=(new u.DOMParser).parseFromString(t);t=o.documentElement&&null!=o.documentElement?this._xml2json(o.documentElement):t}catch(s){}}}return t},e.prototype._valueOfJsonPath=function(e,t,n){var s,a=this._normalize(t);return e.map(function(i){var e=a;if(e&&e instanceof Array){var o=[];i.sort&&(e=i.sort(e)),e.map(function(t){if("object"==typeof t)if(i.key.length){if((a=i.key.length?t[i.key]:t)&&i.validated){var n=!0;i.validated.map(function(e){0==e(a)&&(n=!1)}),n&&o.push(a)}}else if(i.validated){var r=!0;i.validated.map(function(e){0==e(t)&&(r=!1)}),r&&o.push(t)}else o.push(t);else i.key.length&&"string"==typeof t&&t.split(".").map(function(e){0<=e.indexOf(i.key)&&o.push(e)})}),s=a=o}else if(e&&"object"==typeof e){if((a=a?n(e,i.key,i.key.length?a[i.key]:a):undefined)&&a instanceof Array){var r=[];i.sort&&(a=i.sort(a)),a.map(function(t){if(i.validated){var n=!0;i.validated.map(function(e){0==e(t)&&(n=!1)}),n&&r.push(t)}}),a=r}s=a}else e&&"string"==typeof e&&i.key.length?(s=[],e.split(".").map(function(e){0<=e.indexOf(i.key)&&s.push(e)})):s=e}),s},e.prototype._get=function(e){var o=this,t=this.SERVICE_PATH+e,n=e.lastIndexOf("."),r=n<0?undefined:e.toLowerCase().substr(n),i=new c.HttpHeaders;return i.set("Access-Control-Allow-Origin","*"),".xml"===r?(i.set("Content-Type","text; charset=utf-8").set("Accept","text"),this.http.get(t,{headers:i,responseType:"text"}).pipe(s.map(function(e){var t=(new u.DOMParser).parseFromString(e);return o._xml2json(t.documentElement)}))):".txt"===r?(i.set("Content-Type","text; charset=utf-8").set("Accept","text"),this.http.get(t,{headers:i,responseType:"text"}).pipe(s.map(function(e){return e}))):".json"===r?(i.set("Content-Type","json; charset=utf-8").set("Accept","json"),this.http.get(t,{headers:i}).pipe(s.map(function(e){return e}))):(i.set("Content-Type","text; charset=utf-8").set("Accept","text"),this.http.get(t,{headers:i,responseType:"text"}).pipe(s.map(function(e){var t;try{t=JSON.parse(e)}catch(r){try{var n=(new u.DOMParser).parseFromString(e);t=o._xml2json(n.documentElement)}catch(i){t=e}}return t||e})))},e.prototype._stringValueOfKey=function(e){var o=[];return e instanceof Array?e.map(function(e){if(e instanceof Array){var t=[];e.map(function(e){e.key.length&&t.push(e.key)}),o.push(t.join("."))}else if("string"==typeof e){var n=e.indexOf("["),r=e.indexOf("]"),i=e.length>r+1?2:1;o.push(0<n?e.substring(0,n):0<r?e.substring(r+i):e)}else e.key.length&&o.push(e.key)}):o.push(e.key),o.join(",")},e.prototype._addToResult=function(e,t,n,r){var i=this._stringValueOfKey(r.path),o=this._stringValueOfKey(t),s=n.result[i],a=!1;if(s||(n.result[i]={}),s){var u=s[o];n.temp&&n.temp[o]?(s[o]=[s[o]],delete n.temp):u&&u instanceof Array==!1&&(u=[u],s[o]=u),s[o]?s[o].push(this._normalize(e)):s.push(this._normalize(e))}else e instanceof Array&&(n.temp||(n.temp={}),n.temp[o]||(n.temp[o]=!0)),n.result[i][o]=this._normalize(e),a=!0;return a},e.prototype._pack=function(n){var t=this;if(n instanceof Array){var r=[];n.map(function(e){r.push(t._pack(e))}),n=r}else if("object"==typeof n){Object.keys(n).map(function(e){var t=n[e];t instanceof Array||t[e]&&(n[e]=t[e])})}return n},e.prototype._triggerResult=function(e,t){e.next(this._pack(t))},e.prototype._subquery=function(n,e,r,i){var o=this;r.cachedFiles[e]===undefined&&(r.cachedFiles[e]=new a.BehaviorSubject(null),this._queryIteration(r.cachedFiles[e],r,{path:i.path,"in":i["in"],join:i.join,queryItems:i.path instanceof Array?i.path.length:1},e)),r.cachedFiles[e].subscribe(function(e){if(e){var t=i.join?i.join[i.path]:undefined;t?e instanceof Array?e.map(function(e){o._subquery(n,e,r,{path:t.path,"in":t["in"]+e,join:t.join,queryItems:t.path instanceof Array?t.path.length:1})}):o._subquery(n,e,r,{path:i.join[t.path],"in":t["in"]+e,join:t.join,queryItems:t.path instanceof Array?t.path.length:1}):o._addToResult(e,i.path,r,i)?(i.queryItems--,0===i.queryItems&&o._triggerResult(n,r.result)):(i.queryItems--,o._triggerResult(n,r.result))}},function(e){o.logEnabled&&console.log(e),i.queryItems--,o._triggerResult(n,r.result)})},e.prototype._queryIteration=function(i,o,s,e){var a=this;s.handle||(s.handler=function(e,t,n){return n}),this.select(s.path,s["in"],s.handler).subscribe(function(r){if(r)if(e)o.cachedFiles[e].next(r);else if(r instanceof Array){var n=s.join?s.join[s.path]:undefined;if(n)r.map(function(e){var t=e["#text"]?e["#text"]:e;a._subquery(i,t,o,{path:n.path,"in":n["in"]+e,join:n.join,queryItems:n.path instanceof Array?n.path.length:1})});else if(s.queryItems--,0===s.queryItems){o.result&&o.result;a._triggerResult(i,Object.keys(o.result).length?o.result:r)}}else"object"==typeof r?Object.keys(r).map(function(e){var t=r[e],n=s.join?s.join[e]:undefined;t&&t.length&&n?a._subquery(i,t,o,{path:n.path,"in":n["in"]+t,queryItems:n.path instanceof Array?n.path.length:1}):(s.queryItems--,t&&(o.result||(o.result={}),o.result instanceof Array?o.result.push(t):o.result[e]=t),0===s.queryItems&&a._triggerResult(i,Object.keys(o.result).length?o.result:r))}):(s.queryItems--,0===s.queryItems&&0===Object.keys(o.result).length&&r!==undefined&&(o.result=r),a._triggerResult(i,o.result))},function(e){i.error("failed to query "+s.path),s.queryItems--,0===s.queryItems&&a._triggerResult(i,o.result)})},e.prototype._makeArguments=function(e){var t=e.split("."),r=[];return t.map(function(e){var t=e.indexOf("[");if(t<0)r.push({key:e,validated:[function(e){return!0}]});else{var n=e.substring(t+1,e.length-1).split("]["),o={key:e.substring(0,t),validated:[function(e){return!0}]};n.map(function(e){if(-1<(e=(e=e.replace(/\`/g,".")).replace(/\@/g,"data")).indexOf("order-by:")){var t=e.substring(e.indexOf("order-by:")+10).trim().split("~"),r=t[0].trim(),i=t[1]?t[1].trim().toLowerCase():"asc";o.sort=function(e){var n=function(e,t){return e.split(".").map(function(e){t=t[e]}),t};return e.sort(function(e,t){return n(r,e)>n(r,t)?"asc"===i?1:-1:"asc"===i?-1:1})}}else e="return function (data) { var x = false; try{ x = ("+e+"); }catch(e){} return x;}",o.validated.push(new Function(e)())}),r.push(o)}}),r},e.prototype._prepareJsonPath=function(e){var n,r=this;if(e instanceof Array)n=[],e.map(function(e){var t=e.replace(/([\[(])(.+?)([\])])/g,function(e,t,n,r,i,o){return t+n.replace(/\./g,"`")+r});n.push(r._makeArguments(t))});else{var t=(e=e||"").replace(/([\[(])(.+?)([\])])/g,function(e,t,n,r,i,o){return t+n.replace(/\./g,"`")+r});n=this._makeArguments(t)}return n},e.prototype._xml2json=function(e){try{var t={};if(e.attributes)for(var n=e.attributes,r=0;r<n.length;r++){var i=n[r];t[i.name]=i.value}if(e.childNodes&&e.childNodes.length)for(r=0;r<e.childNodes.length;r++){var o=e.childNodes[r],s=o.nodeName;if(t[s]===undefined){(u=this._xml2json(o))&&(t[s]=u)}else{if(t[s].push===undefined){var a=t[s];t[s]=[],t[s].push(a)}var u;(u=this._xml2json(o))&&t[s].push(u)}}else{var c=e.textContent.trim().replace(/(?:\r\n|\r|\n|\t)/g,"");t=c.length?c:undefined}return t}catch(p){this.logEnabled&&console.log(p.message)}},e.prototype.chainSelect=function(e){var t=e.path instanceof Array?e.path.length:1,n=new a.BehaviorSubject(null);return this._queryIteration(n,{cachedFiles:{},result:{}},{path:e.path,"in":e["in"],join:e.join,queryItems:t}),n},e.prototype.arraySelect=function(e,t){var n=this,r={};e.map(function(e){r[e["in"]]===undefined&&(r[e["in"]]=[]),r[e["in"]].push(e.path)});var i=new a.BehaviorSubject(null);return Object.keys(r).map(function(e){n.select(r[e],e,t).subscribe(function(e){e&&i.next(e)},function(e){i.error(e)})}),i},e.prototype.select=function(t,e,o){var s=this,n=new a.BehaviorSubject(null);return this._get(e).subscribe(function(r){var i,e=s._prepareJsonPath(t);o||(o=function(e,t,n){return n}),t instanceof Array?(i={},e.map(function(e){var t=s._valueOfJsonPath(e,r,o);if(t){var n=s._stringValueOfKey(e);i[n]=t}}),0===Object.keys(i).length&&(i=undefined)):"string"==typeof t&&(i=s._valueOfJsonPath(e,r,o)),i?n.next(i):n.error("Result not found for "+t)},function(e){n.error(e)}),n},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:c.HttpClient}]},e}(),i=function(){function e(e){this.queryService=e}return Object.defineProperty(e.prototype,"queryInfo",{set:function(e){var t=this;this.query=e,this.query?(this.selectedDocumentName=this.query["in"].substring(this.query["in"].lastIndexOf("/")),this.queryService.chainSelect({"in":this.query["in"],path:""}).subscribe(function(e){e&&(t.source=e,t.data=undefined)},function(e){t.source=e,t.data=undefined})):(this.data=undefined,this.source=undefined)},enumerable:!0,configurable:!0}),e.prototype.executeQuery=function(e){var t=this,n=JSON.parse(e.value);this.queryService.chainSelect(n).subscribe(function(e){e&&(t.data=e)},function(e){t.data=e})},e.decorators=[{type:n.Component,args:[{selector:"wizard-query",template:'\n<div class="entry" *ngIf="source">\n  <div class="entry-label">Source: {{selectedDocumentName}}</div>\n  <div class="entry-label">Type or modify query</div>\n  <div class="entry-json">{{ source | json }}</div>\n  <textarea #text [value]="query | json" (input)="data = undefined"></textarea>\n  <div class="submit"><button (click)="executeQuery(text)">Execute query</button></div>\n</div>\n\n<div *ngIf="data" class="result-json">{{ data | json }}</div>\n',styles:[".result-json{border:1px solid #633;background-color:#fefefe;border-radius:5px;box-sizing:border-box;display:block;max-height:222px;min-height:222px;overflow-y:auto;position:relative;font-family:monospace;float:left;padding:5px;unicode-bidi:embed;width:100%;white-space:pre-wrap}.entry .entry-json{border:1px solid #633;background-color:#fefefe;box-sizing:border-box;display:block;max-height:222px;min-height:222px;overflow-y:auto;position:relative;font-family:monospace;float:left;padding:5px;unicode-bidi:embed;width:50%;white-space:pre-wrap;border-radius:0 0 0 5px}.entry textarea{width:50%;min-height:222px;max-height:222px;resize:none;box-sizing:border-box;padding:5px;border-radius:0 0 5px}.entry .entry-label{width:50%;font-weight:700;padding:5px;background-color:#888;color:#fff;float:left;box-sizing:border-box}.entry .submit{text-align:center;padding-bottom:5px}.entry .submit button{padding:5px 35px}"]}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={queryInfo:[{type:n.Input}]},e}(),o=function(){function e(e){this.queryService=e,this.onQueryResult=new n.EventEmitter,this.onQueryError=new n.EventEmitter}return Object.defineProperty(e.prototype,"wizardQuery",{set:function(e){var t=this;this.query=e,this.query?this.queryService.chainSelect(this.query).subscribe(function(e){e&&t.onQueryResult.emit(e)},function(e){t.onQueryResult.emit(e)}):this.onQueryResult.emit(undefined)},enumerable:!0,configurable:!0}),e.decorators=[{type:n.Directive,args:[{selector:"[wizardQuery]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={onQueryResult:[{type:n.Output}],onQueryError:[{type:n.Output}],wizardQuery:[{type:n.Input}]},e}(),p=function(){function e(){}return e.decorators=[{type:n.NgModule,args:[{declarations:[i,o],exports:[i,o],imports:[t.CommonModule,c.HttpClientModule],providers:[r],schemas:[n.CUSTOM_ELEMENTS_SCHEMA]}]}],e}();e.WizardQueryComponent=i,e.WizardQueryService=r,e.WizardQueryModule=p,e.ɵa=o,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=wizard-query.umd.min.js.map