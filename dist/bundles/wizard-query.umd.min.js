!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs/operators"),require("rxjs"),require("xmldom"),require("@angular/common"),require("@angular/common/http"),require("@angular/core")):"function"==typeof define&&define.amd?define("wizard-query",["exports","rxjs/operators","rxjs","xmldom","@angular/common","@angular/common/http","@angular/core"],t):t(e["wizard-query"]={},e.rxjs.operators,e.rxjs,e.xmldom,e.ng.common,e.ng.common.http,e.ng.core)}(this,function(e,s,u,c,t,o,n){"use strict";var r=function(){function e(e){this.http=e,this.SERVICE_PATH="",this.logEnabled=!1}return e.prototype._normalize=function(t,n){var r=this;if(t instanceof Array){var i=[];t.map(function(e){i.push(r._normalize(e,n))}),t=i}else if("object"==typeof t){var e=Object.keys(t);if(1!==e.length||t[e[0]]instanceof Array){var a={};e.map(function(e){a[e]=r._normalize(t[e],n)}),t=a}else if(t["#text"])t=t["#text"];else if(t["#cdata-section"]&&(t=t["#cdata-section"],n))try{var s=(new c.DOMParser).parseFromString(t);t=s.documentElement&&null!=s.documentElement?this._xml2json(s.documentElement):t}catch(o){}}return t},e.prototype._valueOfJsonPath=function(e,t,n,s){var o,u=this._normalize(t,n);return e.map(function(i){var e=u;if(e&&e instanceof Array){var a=[];i.sort&&(e=i.sort(e)),e.map(function(t){if("object"==typeof t)if(i.key.length){if((u=i.key.length?t[i.key]:t)&&i.validated){var n=!0;i.validated.map(function(e){0==e(u)&&(n=!1)}),n?a.push(u):u=undefined}}else if(i.validated){var r=!0;i.validated.map(function(e){0==e(t)&&(r=!1)}),r?a.push(t):u=undefined}else a.push(t);else i.key.length&&"string"==typeof t&&t.split(".").map(function(e){0<=e.indexOf(i.key)&&a.push(e)})}),o=u=a}else if(e&&"object"==typeof e){if((u=u?s(e,i.key,i.key.length?u[i.key]:u):undefined)&&u instanceof Array){var r=[];i.sort&&(u=i.sort(u)),u.map(function(t){if(i.validated){var n=!0;i.validated.map(function(e){0==e(t)&&(n=!1)}),n?r.push(t):u=undefined}}),o=u=r}else if(u)if(i.validated){var t=!0;i.validated.map(function(e){0==e(u)&&(t=!1)}),t?o=u:u=undefined}else o=u}else e&&"string"==typeof e&&i.key.length?(o=[],e.split(".").map(function(e){0<=e.indexOf(i.key)&&o.push(e)})):o=e}),o},e.prototype._get=function(e){var a=this,t=this.SERVICE_PATH+e,n=e.lastIndexOf("."),r=n<0?undefined:e.toLowerCase().substr(n),i=new o.HttpHeaders;return i.set("Access-Control-Allow-Origin","*"),".xml"===r?(i.set("Content-Type","text; charset=utf-8").set("Accept","text"),this.http.get(t,{headers:i,responseType:"text"}).pipe(s.map(function(e){var t=(new c.DOMParser).parseFromString(e);return a._xml2json(t.documentElement)}))):".txt"===r?(i.set("Content-Type","text; charset=utf-8").set("Accept","text"),this.http.get(t,{headers:i,responseType:"text"}).pipe(s.map(function(e){return e}))):".json"===r?(i.set("Content-Type","json; charset=utf-8").set("Accept","json"),this.http.get(t,{headers:i}).pipe(s.map(function(e){return e}))):(i.set("Content-Type","text; charset=utf-8").set("Accept","text"),this.http.get(t,{headers:i,responseType:"text"}).pipe(s.map(function(e){var t;try{t=JSON.parse(e)}catch(r){try{var n=(new c.DOMParser).parseFromString(e);t=a._xml2json(n.documentElement)}catch(i){t=e}}return t||e})))},e.prototype._stringValueOfKey=function(e){var a=[];return e instanceof Array?e.map(function(e){if(e instanceof Array){var t=[];e.map(function(e){e.key.length&&t.push(e.key)}),a.push(t.join("."))}else if("string"==typeof e){var n=e.indexOf("["),r=e.indexOf("]"),i=e.length>r+1?2:1;a.push(0<n?e.substring(0,n):0<r?e.substring(r+i):e)}else e.key.length&&a.push(e.key)}):a.push(e.key),a.join(",")},e.prototype._addToResult=function(e,t,n,r){var i=this._stringValueOfKey(r.path),a=this._stringValueOfKey(t),s=n.result[i],o=!1;if(s||(n.result[i]={}),s){var u=s[a];n.temp&&n.temp[a]?(s[a]=[s[a]],delete n.temp):u&&u instanceof Array==!1&&(n.result[i][a]=[u],s=n.result[i]),e=this._normalize(e,r.deepXml),s[a]?s[a].push(e[a]?e[a]:e):s instanceof Array==!1?(n.result[i]=[s],n.result[i].push(e[a]?e[a]:e)):s.push(e[a]?e[a]:e)}else e instanceof Array&&(n.temp||(n.temp={}),n.temp[a]||(n.temp[a]=!0)),n.result[i][a]=this._normalize(e,r.deepXml),o=!0;return o},e.prototype._pack=function(n){var t=this;if(n instanceof Array){var r=[];n.map(function(e){r.push(t._pack(e))}),n=r}else if("object"==typeof n){Object.keys(n).map(function(e){var t=n[e];t instanceof Array||t[e]&&(n[e]=t[e])})}return n},e.prototype._triggerResult=function(e,t){e.next(this._pack(t))},e.prototype._subquery=function(n,e,r,i){var a=this;r.cachedFiles[e]===undefined&&(r.cachedFiles[e]=new u.BehaviorSubject(null),this._queryIteration(r.cachedFiles[e],r,{path:i.path,"in":i["in"],deepXml:i.deepXml,join:i.join,handler:i.handler,queryItems:i.path instanceof Array?i.path.length:1},e)),r.cachedFiles[e].subscribe(function(e){if(e){var t=i.join?i.join[i.path]:undefined;t?e instanceof Array?e.map(function(e){a._subquery(n,e,r,{path:t.path,"in":t["in"]+e,deepXml:t.deepXml,join:t.join,handler:t.handler,queryItems:t.path instanceof Array?t.path.length:1})}):a._subquery(n,e,r,{path:i.join[t.path],"in":t["in"]+e,deepXml:i.deepXml,join:t.join,handler:t.handler,queryItems:t.path instanceof Array?t.path.length:1}):a._addToResult(e,i.path,r,i)?(i.queryItems--,0===i.queryItems&&a._triggerResult(n,r.result)):(i.queryItems--,a._triggerResult(n,r.result))}},function(e){a.logEnabled&&console.log(e),i.queryItems--,a._triggerResult(n,r.result)})},e.prototype._queryIteration=function(i,a,s,e){var o=this;s.handler||(s.handler=function(e,t,n){return n}),this.select(s.path,s["in"],s.deepXml,s.handler).subscribe(function(r){if(r)if(e)a.cachedFiles[e].next(r);else if(r instanceof Array){var n=s.join?s.join[s.path]:undefined;if(n)r.map(function(e){var t=e["#text"]?e["#text"]:e;o._subquery(i,t,a,{path:n.path,"in":n["in"]+e,deepXml:n.deepXml,join:n.join,handler:n.handler,queryItems:n.path instanceof Array?n.path.length:1})});else if(s.queryItems--,0===s.queryItems){a.result&&a.result;o._triggerResult(i,Object.keys(a.result).length?a.result:r)}}else"object"==typeof r?Object.keys(r).map(function(e){var t=r[e],n=s.join?s.join[e]:undefined;t&&t.length&&n?o._subquery(i,t,a,{path:n.path,"in":n["in"]+t,deepXml:n.deepXml,handler:n.handler,queryItems:n.path instanceof Array?n.path.length:1}):(s.queryItems--,t&&(a.result||(a.result={}),a.result instanceof Array?a.result.push(t):a.result[e]=t),0===s.queryItems&&o._triggerResult(i,Object.keys(a.result).length?a.result:r))}):(s.queryItems--,0===s.queryItems&&0===Object.keys(a.result).length&&r!==undefined&&(a.result=r),o._triggerResult(i,a.result))},function(e){i.error({message:"failed to query "+s.path,reason:e.message?e.message:e}),s.queryItems--,0===s.queryItems&&o._triggerResult(i,a.result)})},e.prototype._makeArguments=function(e){var t=e.split("."),r=[];return t.map(function(e){var t=e.indexOf("[");if(t<0)r.push({key:e,validated:[function(e){return!0}]});else{var n=e.substring(t+1,e.length-1).split("]["),a={key:e.substring(0,t),validated:[function(e){return!0}]};n.map(function(e){if(-1<(e=(e=e.replace(/\`/g,".")).replace(/\@/g,"data")).indexOf("order-by:")){var t=e.substring(e.indexOf("order-by:")+10).trim().split("~"),r=t[0].trim(),i=t[1]?t[1].trim().toLowerCase():"asc";a.sort=function(e){var n=function(e,t){return e.split(".").map(function(e){t=t[e]}),t};return e.sort(function(e,t){return n(r,e)>n(r,t)?"asc"===i?1:-1:"asc"===i?-1:1})}}else e="return function (data) { var x = false; try{ x = ("+e+"); }catch(e){} return x;}",a.validated.push(new Function(e)())}),r.push(a)}}),r},e.prototype._prepareJsonPath=function(e){var n,r=this;if(e instanceof Array)n=[],e.map(function(e){var t=e.replace(/([\[(])(.+?)([\])])/g,function(e,t,n,r,i,a){return t+n.replace(/\./g,"`")+r});n.push(r._makeArguments(t))});else{var t=(e=e||"").replace(/([\[(])(.+?)([\])])/g,function(e,t,n,r,i,a){return t+n.replace(/\./g,"`")+r});n=this._makeArguments(t)}return n},e.prototype._xml2json=function(e){try{var t={};if(e.attributes)for(var n=e.attributes,r=0;r<n.length;r++){var i=n[r];t[i.name]=i.value}if(e.childNodes&&e.childNodes.length)for(r=0;r<e.childNodes.length;r++){var a=e.childNodes[r],s=a.nodeName;if(t[s]===undefined){(u=this._xml2json(a))&&(t[s]=u)}else{if(t[s].push===undefined){var o=t[s];t[s]=[],t[s].push(o)}var u;(u=this._xml2json(a))&&t[s].push(u)}}else{var c=e.textContent.trim().replace(/(?:\r\n|\r|\n|\t)/g,"");t=c.length?c:undefined}return t}catch(p){this.logEnabled&&console.log(p.message)}},e.prototype.chainSelect=function(e){var t=e.path instanceof Array?e.path.length:1,n=new u.BehaviorSubject(null);return this._queryIteration(n,{cachedFiles:{},result:{}},{path:e.path,"in":e["in"],deepXml:e.deepXml,join:e.join,handler:e.handler,queryItems:t}),n},e.prototype.arraySelect=function(e,t){var n=this,r={};e.map(function(e){r[e["in"]]===undefined&&(r[e["in"]]=[]),r[e["in"]].push({path:e.path,deepXml:e.deepXml})});var i=new u.BehaviorSubject(null);return Object.keys(r).map(function(e){n.select(r[e].path,e,r[e].deepXml,t).subscribe(function(e){e&&i.next(e)},function(e){i.error(e)})}),i},e.prototype.select=function(t,e,a,s){var o=this,n=new u.BehaviorSubject(null);return this._get(e).subscribe(function(r){var i,e=o._prepareJsonPath(t);s||(s=function(e,t,n){return n}),t instanceof Array?(i={},e.map(function(e){var t=o._valueOfJsonPath(e,r,a,s);if(t){var n=o._stringValueOfKey(e);i[n]=t}}),0===Object.keys(i).length&&(i=undefined)):"string"==typeof t&&(i=o._valueOfJsonPath(e,r,a,s)),i?n.next(i):n.error("Result not found for "+t)},function(e){n.error(e)}),n},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:o.HttpClient}]},e}(),i=function(){function e(e){this.queryService=e}return Object.defineProperty(e.prototype,"queryInfo",{set:function(e){var t=this;this.query=e,this.query?(this.selectedDocumentName=this.query["in"].substring(this.query["in"].lastIndexOf("/")),this.queryService.chainSelect({"in":this.query["in"],path:""}).subscribe(function(e){e&&(t.source=e,t.data=undefined)},function(e){t.source=e,t.data=undefined})):(this.data=undefined,this.source=undefined)},enumerable:!0,configurable:!0}),e.prototype.parseFunctions=function(t){var n=this;t instanceof Array?t.map(function(e){n.parseFunctions(e)}):"object"==typeof t&&Object.keys(t).map(function(e){"handler"===e?t[e]=new Function(t[e])():n.parseFunctions(t[e])})},e.prototype.executeQuery=function(e){var t=this;try{var n=JSON.parse(e.value);this.parseFunctions(n),n instanceof Array?this.queryService.arraySelect(n).subscribe(function(e){e&&(t.data=e)},function(e){t.data={alert:e}}):this.queryService.chainSelect(n).subscribe(function(e){e&&(t.data=e)},function(e){t.data={alert:e}})}catch(r){this.data={alert:r.message}}},e.decorators=[{type:n.Component,args:[{selector:"wizard-query",template:'\n<div class="entry" *ngIf="source">\n  <div class="entry-label">Source: {{selectedDocumentName}}</div>\n  <div class="entry-label">Type or modify query</div>\n  <div class="entry-json">{{ source | json }}</div>\n  <textarea #text [value]="query | json" (input)="data = undefined"></textarea>\n  <div class="submit"><button (click)="executeQuery(text)">Execute query</button></div>\n</div>\n\n<div *ngIf="data" class="result-json">{{ data | json }}</div>\n',styles:[".result-json{border:1px solid #633;background-color:#fefefe;border-radius:5px;box-sizing:border-box;display:block;max-height:222px;min-height:222px;overflow-y:auto;position:relative;font-family:monospace;float:left;padding:5px;unicode-bidi:embed;width:100%;white-space:pre-wrap}.entry .entry-json{border:1px solid #633;background-color:#fefefe;box-sizing:border-box;display:block;max-height:222px;min-height:222px;overflow-y:auto;position:relative;font-family:monospace;float:left;padding:5px;unicode-bidi:embed;width:50%;white-space:pre-wrap;border-radius:0 0 0 5px}.entry textarea{width:50%;min-height:222px;max-height:222px;resize:none;box-sizing:border-box;padding:5px;border-radius:0 0 5px}.entry .entry-label{width:50%;font-weight:700;padding:5px;background-color:#888;color:#fff;float:left;box-sizing:border-box}.entry .submit{text-align:center;padding-bottom:5px}.entry .submit button{padding:5px 35px}"]}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={queryInfo:[{type:n.Input}]},e}(),a=function(){function e(e){this.queryService=e,this.onQueryResult=new n.EventEmitter,this.onQueryError=new n.EventEmitter}return Object.defineProperty(e.prototype,"wizardQuery",{set:function(e){var t=this;this.query=e,this.query?this.query instanceof Array?this.queryService.arraySelect(this.query).subscribe(function(e){e&&t.onQueryResult.emit(e)},function(e){t.onQueryResult.emit({alert:e})}):this.queryService.chainSelect(this.query).subscribe(function(e){e&&t.onQueryResult.emit(e)},function(e){t.onQueryResult.emit({alert:e})}):this.onQueryResult.emit(undefined)},enumerable:!0,configurable:!0}),e.decorators=[{type:n.Directive,args:[{selector:"[wizardQuery]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={onQueryResult:[{type:n.Output}],onQueryError:[{type:n.Output}],wizardQuery:[{type:n.Input}]},e}(),p=function(){function e(){}return e.decorators=[{type:n.NgModule,args:[{declarations:[i,a],exports:[i,a],imports:[t.CommonModule,o.HttpClientModule],providers:[r],schemas:[n.CUSTOM_ELEMENTS_SCHEMA]}]}],e}();e.WizardQueryComponent=i,e.WizardQueryService=r,e.WizardQueryModule=p,e.ɵa=a,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=wizard-query.umd.min.js.map