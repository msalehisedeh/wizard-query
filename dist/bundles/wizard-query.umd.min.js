!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs/operators"),require("rxjs"),require("xmldom"),require("@angular/core"),require("@angular/common"),require("@angular/common/http")):"function"==typeof define&&define.amd?define("wizard-query",["exports","rxjs/operators","rxjs","xmldom","@angular/core","@angular/common","@angular/common/http"],t):t(e["wizard-query"]={},e.rxjs.operators,e.rxjs,e.xmldom,e.ng.core,e.ng.common,e.ng.common.http)}(this,function(e,s,l,u,t,n,o){"use strict";var r=function(){function e(e){this.http=e,this.SERVICE_PATH="",this.logEnabled=!1}return e.prototype._globalFunctions=function(){return"\n        function reverse(a) {\n            var result = a;\n            if (a instanceof Array) {\n                result = a.reverse();\n            } else if (typeof a === 'string') {\n                result = a.split('').reverse().join('');\n            }\n            return result;\n        }\n        function sum(a,b) {\n            var total = 0;\n            if (a instanceof Array) { \n                a.map(function(k) {\n                    total += sum(k, b);\n                });\n            } else if (typeof a === 'object') {\n                if (b.indexOf('.')>0) {\n                    var t = a;\n                    b.split('.').map(function(k){\n                        total+=sum( t[k], b.substring(k.length+1) );\n                    });\n                } else if(a[b]) {\n                    var t = a[b];\n                    total += (typeof t === 'number') ? t : parseFloat(t);\n                } \n            } else if (typeof a === 'number') {\n                total = a;\n            } \n            return total;\n        }\n        function count(a,b) {\n            var total = 0;\n            if (a instanceof Array) { \n                a.map(function(k) {\n                    total += count(k, b);\n                });\n            } else if (typeof a === 'object') {\n                Object.keys(a).map(function(k){\n                    total += count(a[k],b);\n                });\n            } else if (typeof a === 'string') {\n                total = a.split(b).length - 1;\n            } else if (a === b) {\n                total++;\n            }\n            return total;\n        }\n        function like(a, b) {\n            var result = undefined;\n            if (a instanceof Array) {\n                result = [];\n                a.map(function(k) {\n                    result.push(like(k, b));\n                });\n            } else if (typeof a === 'object') {\n                result = [];\n                Object.keys(a).map(function(k){\n                    result.push(like(a[k], b));\n                });\n            } else if (typeof a === 'string') {\n                if (a.indexOf(b) > -1) {\n                    result = a;\n                }\n            } else if (a === b) {\n                result = a;\n            }\n            return result;\n        }\n        function as(a, b) {\n            if (asList[b] === undefined) {\n                asList[b] = [a];\n            } else {\n                asList[b].push(a);\n            }\n            return a;\n        }\n        function is_in(a, b, list) {\n            var result = undefined;\n            if (b instanceof Array) { \n                result = [];\n                b.map(function(k) {\n                    result.push(is_in(k, list));\n                });\n            } else if (typeof b === 'object') {\n                result = [];\n                Object.keys(b).map(function(k) {\n                    result.push(is_in(b[k], list));\n                });\n            } else if (asList[list]){\n                asList[list].map(function(t) {\n                    if (typeof t ==='string') {\n                        if (t.indexOf(b) > -1) {\n                            result = a;\n                        }\n                    }\n                });\n            }\n            return result;\n        }\n        "},e.prototype._normalize=function(t,n){var r=this;if(t instanceof Array){var i=[];t.map(function(e){i.push(r._normalize(e,n))}),t=i}else if("object"==typeof t){var e=Object.keys(t);if(1!==e.length||t[e[0]]instanceof Array){var a={};e.map(function(e){a[e]=r._normalize(t[e],n)}),t=a}else if(t["#text"])t=t["#text"];else if(t["#cdata-section"]&&(t=t["#cdata-section"],n))try{var s=(new u.DOMParser).parseFromString(t);t=s.documentElement&&null!=s.documentElement?this._xml2json(s.documentElement):t}catch(o){}}return t},e.prototype._valueOfJsonPath=function(e,t,s,n,r){var o,u=this._normalize(t,n);return e.map(function(t){var e=u;if(e&&e instanceof Array){var a=[];t.sort&&(e=t.sort(e)),e.map(function(n){if("object"==typeof n)if(t.key.length){if((u=t.key.length?n[t.key]:n)&&t.validated){var r=!0;t.validated.map(function(e){var t=e(u,s);"boolean"==typeof t?0==t&&(r=!1):u=t}),r&&u?a.push(u):u=undefined}}else if(t.validated){var i=!0;t.validated.map(function(e){var t=e(n,s);"boolean"==typeof t?0==t&&(i=!1):n=t}),i&&n?a.push(n):u=undefined}else a.push(n);else t.key.length&&"string"==typeof n&&n.split(".").map(function(e){0<=e.indexOf(t.key)&&a.push(e)})}),o=u=a}else if(e&&"object"==typeof e){if((u=u?r(e,t.key,t.key.length?u[t.key]:u):undefined)&&u instanceof Array){var i=[];t.sort&&(u=t.sort(u)),u.map(function(n){if(t.validated){var r=!0;t.validated.map(function(e){var t=e(n,s);"boolean"==typeof t?0==t&&(r=!1):n=t}),r&&n?i.push(n):u=undefined}}),o=u=i}else if(u)if(t.validated){var n=!0;t.validated.map(function(e){var t=e(u,s);"boolean"==typeof t?0==t&&(n=!1):u=t}),n&&u?o=u:u=undefined}else o=u}else e&&"string"==typeof e&&t.key.length?(o=[],e.split(".").map(function(e){0<=e.indexOf(t.key)&&o.push(e)})):o=e}),o},e.prototype._get=function(e){var a=this,t=this.SERVICE_PATH+e,n=e.lastIndexOf("."),r=n<0?undefined:e.toLowerCase().substr(n),i=new o.HttpHeaders;return i.set("Access-Control-Allow-Origin","*"),".xml"===r?(i.set("Content-Type","text; charset=utf-8").set("Accept","text"),this.http.get(t,{headers:i,responseType:"text"}).pipe(s.map(function(e){var t=(new u.DOMParser).parseFromString(e);return a._xml2json(t.documentElement)}))):".txt"===r?(i.set("Content-Type","text; charset=utf-8").set("Accept","text"),this.http.get(t,{headers:i,responseType:"text"}).pipe(s.map(function(e){return e}))):".json"===r?(i.set("Content-Type","json; charset=utf-8").set("Accept","json"),this.http.get(t,{headers:i}).pipe(s.map(function(e){return e}))):(i.set("Content-Type","text; charset=utf-8").set("Accept","text"),this.http.get(t,{headers:i,responseType:"text"}).pipe(s.map(function(e){var t;try{t=JSON.parse(e)}catch(r){try{var n=(new u.DOMParser).parseFromString(e);t=a._xml2json(n.documentElement)}catch(i){t=e}}return t||e})))},e.prototype._stringValueOfKey=function(e){var a=[];return a=e instanceof Array?(e.map(function(e){if(e instanceof Array){var t=[];e.map(function(e){e.key.length&&t.push(e.key)}),a.push(t.join("."))}else if("string"==typeof e){var n=e.indexOf("["),r=e.indexOf("]"),i=e.length>r+1?2:1;a.push(0<n?e.substring(0,n):0<r?e.substring(r+i):e)}else e.key.length&&a.push(e.key)}),(a=a.join(",")).indexOf(".")<0?a.replace(/\,/g,"."):a):e.key},e.prototype._addToResult=function(e,t,n,r){var i=this._stringValueOfKey(r.path),a=this._stringValueOfKey(t),s=n.result[i],o=!1;if(s||(n.result[i]={}),s){var u=s[a];n.temp&&n.temp[a]?(s[a]=[s[a]],delete n.temp):u&&u instanceof Array==!1&&(n.result[i][a]=[u],s=n.result[i]),e=this._normalize(e,r.deepXml),s[a]?"object"==typeof e?JSON.stringify(e)!==JSON.stringify(s[a][0])&&s[a].push(e[a]?e[a]:e):s[a].push(e[a]?e[a]:e):s instanceof Array==!1?(n.result[i]=[s],n.result[i].push(e[a]?e[a]:e)):"object"==typeof e?JSON.stringify(e)!==JSON.stringify(s[0])&&s.push(e[a]?e[a]:e):s.push(e[a]?e[a]:e)}else e instanceof Array&&(n.temp||(n.temp={}),n.temp[a]||(n.temp[a]=!0)),n.result[i][a]=this._normalize(e,r.deepXml),o=!0;return o},e.prototype._pack=function(n){var t=this;if(n instanceof Array){var r=[];n.map(function(e){r.push(t._pack(e))}),n=r}else if("object"==typeof n){Object.keys(n).map(function(e){var t=n[e];t instanceof Array||t[e]&&(n[e]=t[e])})}return n},e.prototype._triggerResult=function(e,t,n){var r,i=this._pack(n);return t&&("string"==typeof t?(r={})[t]=i:"object"==typeof t&&(r=t)),e.next(i),r},e.prototype._subquery=function(n,e,r,i){var a=this;r.cachedFiles[e]===undefined&&(r.cachedFiles[e]=new l.BehaviorSubject(null),this._queryIteration(r.cachedFiles[e],r,{path:i.path,"in":i["in"],deepXml:i.deepXml,join:i.join,handler:i.handler,queryItems:i.path instanceof Array?i.path.length:1},e)),r.cachedFiles[e].subscribe(function(e){if(e){var t=i.join?i.join[i.path]:undefined;t?e instanceof Array?e.map(function(e){a._subquery(n,e,r,{path:t.path,"in":t["in"]==undefined?i["in"]:t["in"]+e,deepXml:t.deepXml,join:t.join,handler:t.handler,queryItems:t.path instanceof Array?t.path.length:1})}):a._subquery(n,e,r,{path:i.join[t.path],"in":t["in"]==undefined?i["in"]:t["in"]+e,deepXml:i.deepXml,join:t.join,handler:t.handler,queryItems:t.path instanceof Array?t.path.length:1}):a._addToResult(e,i.path,r,i)?(i.queryItems--,0===i.queryItems&&(r.as=a._triggerResult(n,r.as,r.result))):(i.queryItems--,r.as=a._triggerResult(n,r.as,r.result))}},function(e){a.logEnabled&&console.log(e),i.queryItems--,r.as=a._triggerResult(n,r.as,r.result)})},e.prototype._queryIteration=function(a,s,o,e){var u=this;o.handler||(o.handler=function(e,t,n){return n}),this._select(o.path,o["in"],o.deepXml,s.as,o.handler).subscribe(function(i){if(i)if(e)s.cachedFiles[e].next(i);else if(i instanceof Array){var r=o.join?o.join[o.path]:undefined;if(r)i.map(function(e){var t=e["#text"]?e["#text"]:e,n=r.path instanceof Array?r.path.length:1;r["in"]==undefined&&(s.cachedFiles[t]=u._select(r.path,o["in"],r.deepXml,s.as,r.handler),n--),u._subquery(a,t,s,{path:r.path,"in":r["in"]==undefined?o["in"]:r["in"]+e,deepXml:r.deepXml,join:r.join,handler:r.handler,queryItems:n})});else if(o.queryItems--,0===o.queryItems){s.result&&s.result;s.as=u._triggerResult(a,s.as,Object.keys(s.result).length?s.result:i)}}else"object"==typeof i?Object.keys(i).map(function(e){var t=i[e],n=o.join?o.join[e]:undefined;if(t&&t.length&&n){var r=n.path instanceof Array?n.path.length:1;n["in"]==undefined&&(s.cachedFiles[t]=u._select(n.path,o["in"],n.deepXml,s.as,n.handler),r--),u._subquery(a,t,s,{path:n.path,"in":n["in"]==undefined?o["in"]:n["in"]+t,deepXml:n.deepXml,handler:n.handler,queryItems:r})}else o.queryItems--,t&&(s.result||(s.result={}),s.result instanceof Array?s.result.push(t):s.result[e]=t),0===o.queryItems&&(s.as=u._triggerResult(a,s.as,Object.keys(s.result).length?s.result:i))}):(o.queryItems--,0===o.queryItems&&0===Object.keys(s.result).length&&i!==undefined&&(s.result=i),s.as=u._triggerResult(a,s.as,s.result))},function(e){a.error({message:"failed to query "+o.path,reason:e.message?e.message:e}),o.queryItems--,0===o.queryItems&&(s.as=u._triggerResult(a,s.as,s.result))})},e.prototype._makeArguments=function(e){var o=this,t=e.split("."),r=[];return t.map(function(e){var t=e.indexOf("[");if(t<0)r.push({key:e,validated:[function(e,t){return!0}]});else{var n=e.substring(t+1,e.length-1).split("]["),s={key:e.substring(0,t),validated:[function(e,t){return!0}]};n.map(function(e){if(-1<(e=(e=e.replace(/\`/g,".")).replace(/\@/g,"data")).indexOf("order-by:")){var t=e.substring(e.indexOf("order-by:")+10).trim().split("~"),r=t[0].trim(),i=t[1]?t[1].trim().toLowerCase():"asc";s.sort=function(e){var n=function(e,t){return e.split(".").map(function(e){t=t[e]}),t};return e.sort(function(e,t){return n(r,e)>n(r,t)?"asc"===i?1:-1:"asc"===i?-1:1})}}else{var n=0<e.indexOf("&&")||0<e.indexOf("||"),a="return function (data, asList) { \n";a+=o._globalFunctions(),a+="var x = false;\n try{\n x = ",a+=(n?"("+e+")":e)+"; \n}catch(e){}\n return x;\n}",s.validated.push(new Function(a)())}}),r.push(s)}}),r},e.prototype._handleSpecialCharacters=function(e){var r=[];return e.split("]").map(function(e){var t=e.indexOf("[");if(0<=t){var n="";0<t&&(n+=e.substring(0,t)),n+=e.substring(t).replace(/\./g,"`"),r.push(n)}else r.push(e)}),r.join("]")},e.prototype._prepareJsonPath=function(e){var n,r=this;if(e instanceof Array)n=[],e.map(function(e){var t=r._handleSpecialCharacters(e);n.push(r._makeArguments(t))});else{var t=this._handleSpecialCharacters(e);n=this._makeArguments(t)}return n},e.prototype._select=function(t,e,a,s,o){var u=this,n=new l.BehaviorSubject(null);return this._get(e).subscribe(function(r){var i,e=u._prepareJsonPath(t);o||(o=function(e,t,n){return n}),t instanceof Array?(i={},e.map(function(e){var t=u._valueOfJsonPath(e,r,s,a,o);if(t){var n=u._stringValueOfKey(e);i[n]=t}}),0===Object.keys(i).length&&(i=undefined)):"string"==typeof t&&(i=u._valueOfJsonPath(e,r,s,a,o)),i?n.next(i):n.error("Result not found for "+t)},function(e){n.error(e)}),n},e.prototype._xml2json=function(e){try{var t={};if(e.attributes)for(var n=e.attributes,r=0;r<n.length;r++){var i=n[r];t[i.name]=i.value}if(e.childNodes&&e.childNodes.length)for(r=0;r<e.childNodes.length;r++){var a=e.childNodes[r],s=a.nodeName;if(t[s]===undefined){(u=this._xml2json(a))&&(t[s]=u)}else{if(t[s].push===undefined){var o=t[s];t[s]=[],t[s].push(o)}var u;(u=this._xml2json(a))&&t[s].push(u)}}else{var l=e.textContent.trim().replace(/(?:\r\n|\r|\n|\t)/g,"");t=l.length?l:undefined}return t}catch(c){this.logEnabled&&console.log(c.message)}},e.prototype.chainSelect=function(e){var t=e.path instanceof Array?e.path.length:1,n={cachedFiles:{},as:{},result:{}},r=new l.BehaviorSubject(null);return n.cachedFiles[e.path]=r,this._queryIteration(r,n,{path:e.path,"in":e["in"],deepXml:e.deepXml,join:e.join,handler:e.handler,queryItems:t}),r},e.prototype.arraySelect=function(e,t){var n=this,r={};e.map(function(e){r[e["in"]]===undefined&&(r[e["in"]]=[]),r[e["in"]].push({path:e.path,deepXml:e.deepXml})});var i=new l.BehaviorSubject(null);return Object.keys(r).map(function(e){n._select(r[e].path,e,r[e].deepXml,undefined,t).subscribe(function(e){e&&i.next(e)},function(e){i.error(e)})}),i},e.prototype.select=function(e,t,n,r){return this._select(e,t,n,undefined,r)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:o.HttpClient}]},e}(),i=function(){function e(e){this.queryService=e}return Object.defineProperty(e.prototype,"queryInfo",{set:function(e){var t=this;this.query=e,this.query?(this.selectedDocumentName=this.query["in"].substring(this.query["in"].lastIndexOf("/")),this.queryService.chainSelect({"in":this.query["in"],path:""}).subscribe(function(e){e&&(t.source=e,t.data=undefined)},function(e){t.source=e,t.data=undefined})):(this.data=undefined,this.source=undefined)},enumerable:!0,configurable:!0}),e.prototype.parseFunctions=function(t){var n=this;t instanceof Array?t.map(function(e){n.parseFunctions(e)}):"object"==typeof t&&Object.keys(t).map(function(e){"handler"===e?t[e]=new Function("return function"+t[e])():n.parseFunctions(t[e])})},e.prototype.executeQuery=function(e){var t=this;try{var n=JSON.parse(e.value);this.parseFunctions(n),n instanceof Array?this.queryService.arraySelect(n).subscribe(function(e){e&&(t.data=e)},function(e){t.data={alert:e}}):this.queryService.chainSelect(n).subscribe(function(e){e&&(t.data=e)},function(e){t.data={alert:e}})}catch(r){this.data={alert:r.message}}},e.decorators=[{type:t.Component,args:[{selector:"wizard-query",template:'\n<div class="entry" *ngIf="source">\n  <div class="entry-label">Source: {{selectedDocumentName}}</div>\n  <div class="entry-label">Type or modify query</div>\n  <div class="entry-json">{{ source | json }}</div>\n  <textarea #text [value]="query | json" (input)="data = undefined"></textarea>\n  <div class="submit"><button (click)="executeQuery(text)">Execute query</button></div>\n</div>\n\n<div *ngIf="data" class="result-json">{{ data | json }}</div>\n',styles:[".result-json{border:1px solid #633;background-color:#fefefe;border-radius:5px;box-sizing:border-box;display:block;max-height:222px;min-height:222px;overflow-y:auto;position:relative;font-family:monospace;float:left;padding:5px;unicode-bidi:embed;width:100%;white-space:pre-wrap}.entry .entry-json{border:1px solid #633;background-color:#fefefe;box-sizing:border-box;display:block;max-height:222px;min-height:222px;overflow-y:auto;position:relative;font-family:monospace;float:left;padding:5px;unicode-bidi:embed;width:50%;white-space:pre-wrap;border-radius:0 0 0 5px}.entry textarea{width:50%;min-height:222px;max-height:222px;resize:none;box-sizing:border-box;padding:5px;border-radius:0 0 5px}.entry .entry-label{width:50%;font-weight:700;padding:5px;background-color:#888;color:#fff;float:left;box-sizing:border-box}.entry .submit{text-align:center;padding-bottom:5px}.entry .submit button{padding:5px 35px}"]}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={queryInfo:[{type:t.Input}]},e}(),a=function(){function e(e){this.queryService=e,this.onQueryResult=new t.EventEmitter,this.onQueryError=new t.EventEmitter}return Object.defineProperty(e.prototype,"wizardQuery",{set:function(e){var t=this;this.query=e,this.query?this.query instanceof Array?this.queryService.arraySelect(this.query).subscribe(function(e){e&&t.onQueryResult.emit(e)},function(e){t.onQueryResult.emit({alert:e})}):this.queryService.chainSelect(this.query).subscribe(function(e){e&&t.onQueryResult.emit(e)},function(e){t.onQueryResult.emit({alert:e})}):this.onQueryResult.emit(undefined)},enumerable:!0,configurable:!0}),e.decorators=[{type:t.Directive,args:[{selector:"[wizardQuery]"}]}],e.ctorParameters=function(){return[{type:r}]},e.propDecorators={onQueryResult:[{type:t.Output}],onQueryError:[{type:t.Output}],wizardQuery:[{type:t.Input}]},e}(),c=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{declarations:[i,a],exports:[i,a],imports:[n.CommonModule,o.HttpClientModule],providers:[r],schemas:[t.CUSTOM_ELEMENTS_SCHEMA]}]}],e}();e.WizardQueryComponent=i,e.WizardQueryService=r,e.WizardQueryDirective=a,e.WizardQueryModule=c,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=wizard-query.umd.min.js.map