!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs/operators"),require("rxjs"),require("xmldom"),require("@angular/common")):"function"==typeof define&&define.amd?define("@sedeh/wizard-query",["exports","@angular/core","@angular/common/http","rxjs/operators","rxjs","xmldom","@angular/common"],t):t(((e=e||self).sedeh=e.sedeh||{},e.sedeh["wizard-query"]={}),e.ng.core,e.ng.common.http,e.rxjs.operators,e.rxjs,e.xmldom,e.ng.common)}(this,(function(e,t,n,r,i,a,s){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function o(e,t,n,r){var i,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var o=e.length-1;o>=0;o--)(i=e[o])&&(s=(a<3?i(s):a>3?i(t,n,s):i(t,n))||s);return a>3&&s&&Object.defineProperty(t,n,s),s}var u=function(){function e(e){this.http=e,this.SERVICE_PATH="",this.logEnabled=!1}return e.prototype._globalFunctions=function(){return"\n        function reverse(a) {\n            var result = a;\n            if (a instanceof Array) {\n                result = a.reverse();\n            } else if (typeof a === 'string') {\n                result = a.split('').reverse().join('');\n            }\n            return result;\n        }\n        function sum(a,b) {\n            var total = 0;\n            if (a instanceof Array) { \n                a.map(function(k) {\n                    total += sum(k, b);\n                });\n            } else if (typeof a === 'object') {\n                if (b.indexOf('.')>0) {\n                    var t = a;\n                    b.split('.').map(function(k){\n                        total+=sum( t[k], b.substring(k.length+1) );\n                    });\n                } else if(a[b]) {\n                    var t = a[b];\n                    total += (typeof t === 'number') ? t : parseFloat(t);\n                } \n            } else if (typeof a === 'number') {\n                total = a;\n            } \n            return total;\n        }\n        function count(a,b) {\n            var total = 0;\n            if (a instanceof Array) { \n                a.map(function(k) {\n                    total += count(k, b);\n                });\n            } else if (typeof a === 'object') {\n                Object.keys(a).map(function(k){\n                    total += count(a[k],b);\n                });\n            } else if (typeof a === 'string') {\n                total = a.split(b).length - 1;\n            } else if (a === b) {\n                total++;\n            }\n            return total;\n        }\n        function like(a, b) {\n            var result = undefined;\n            if (a instanceof Array) {\n                result = [];\n                a.map(function(k) {\n                    result.push(like(k, b));\n                });\n            } else if (typeof a === 'object') {\n                result = [];\n                Object.keys(a).map(function(k){\n                    result.push(like(a[k], b));\n                });\n            } else if (typeof a === 'string') {\n                if (a.indexOf(b) > -1) {\n                    result = a;\n                }\n            } else if (a === b) {\n                result = a;\n            }\n            return result;\n        }\n        function as(a, b) {\n            if (asList[b] === undefined) {\n                asList[b] = [a];\n            } else {\n                asList[b].push(a);\n            }\n            return a;\n        }\n        function is_in(a, b, list) {\n            var result = undefined;\n            if (b instanceof Array) { \n                result = [];\n                b.map(function(k) {\n                    result.push(is_in(k, list));\n                });\n            } else if (typeof b === 'object') {\n                result = [];\n                Object.keys(b).map(function(k) {\n                    result.push(is_in(b[k], list));\n                });\n            } else if (asList[list]){\n                asList[list].map(function(t) {\n                    if (typeof t ==='string') {\n                        if (t.indexOf(b) > -1) {\n                            result = a;\n                        }\n                    }\n                });\n            }\n            return result;\n        }\n        "},e.prototype._normalize=function(e,t){var n=this;if(e instanceof Array){var r=[];e.map((function(e){r.push(n._normalize(e,t))})),e=r}else if("object"==typeof e){var i=Object.keys(e);if(1!==i.length||e[i[0]]instanceof Array){var s={};i.map((function(r){s[r]=n._normalize(e[r],t)})),e=s}else if(e["#text"])e=e["#text"];else if(e["#cdata-section"]&&(e=e["#cdata-section"],t))try{var o=(new a.DOMParser).parseFromString(e);e=o.documentElement&&null!=o.documentElement?this._xml2json(o.documentElement):e}catch(e){}}return e},e.prototype._valueOfJsonPath=function(e,t,n,r,i){var a,s=this._normalize(t,r);return e.map((function(e){var t=s;if(t&&t instanceof Array){var r=[];e.sort&&(t=e.sort(t)),t.map((function(t){if("object"==typeof t)if(e.key.length){if((s=e.key.length?t[e.key]:t)&&e.validated){var i=!0;e.validated.map((function(e){var t=e(s,n);"boolean"==typeof t?0==t&&(i=!1):s=t})),i&&s?r.push(s):s=void 0}}else if(e.validated){var a=!0;e.validated.map((function(e){var r=e(t,n);"boolean"==typeof r?0==r&&(a=!1):t=r})),a&&t?r.push(t):s=void 0}else r.push(t);else e.key.length&&"string"==typeof t&&t.split(".").map((function(t){t.indexOf(e.key)>=0&&r.push(t)}))})),a=s=r}else if(t&&"object"==typeof t){if((s=s?i(t,e.key,e.key.length?s[e.key]:s):void 0)&&s instanceof Array){var o=[];e.sort&&(s=e.sort(s)),s.map((function(t){if(e.validated){var r=!0;e.validated.map((function(e){var i=e(t,n);"boolean"==typeof i?0==i&&(r=!1):t=i})),r&&t?o.push(t):s=void 0}})),a=s=o}else if(s)if(e.validated){var u=!0;e.validated.map((function(e){var t=e(s,n);"boolean"==typeof t?0==t&&(u=!1):s=t})),u&&s?a=s:s=void 0}else a=s}else t&&"string"==typeof t&&e.key.length?(a=[],t.split(".").map((function(t){t.indexOf(e.key)>=0&&a.push(t)}))):a=t})),a},e.prototype._get=function(e){var t,i=this,s=this.SERVICE_PATH+e,o=e.lastIndexOf("."),u=o<0?void 0:e.toLowerCase().substr(o),l=new n.HttpHeaders;return l.set("Access-Control-Allow-Origin","*"),".xml"===u?(l.set("Content-Type","text; charset=utf-8").set("Accept","text"),t=this.http.get(s,{headers:l,responseType:"text"}).pipe(r.map((function(e){var t=(new a.DOMParser).parseFromString(e);return i._xml2json(t.documentElement)})))):".txt"===u?(l.set("Content-Type","text; charset=utf-8").set("Accept","text"),t=this.http.get(s,{headers:l,responseType:"text"}).pipe(r.map((function(e){return e})))):".json"===u?(l.set("Content-Type","json; charset=utf-8").set("Accept","json"),t=this.http.get(s,{headers:l}).pipe(r.map((function(e){return e})))):(l.set("Content-Type","text; charset=utf-8").set("Accept","text"),t=this.http.get(s,{headers:l,responseType:"text"}).pipe(r.map((function(e){var t;try{t=JSON.parse(e)}catch(r){try{var n=(new a.DOMParser).parseFromString(e);t=i._xml2json(n.documentElement)}catch(n){t=e}}return t||e})))),t},e.prototype._stringValueOfKey=function(e){var t=[];return e instanceof Array?(e.map((function(e){if(e instanceof Array){var n=[];e.map((function(e){e.key.length&&n.push(e.key)})),t.push(n.join("."))}else if("string"==typeof e){var r=e.indexOf("["),i=e.indexOf("]"),a=e.length>i+1?2:1;t.push(r>0?e.substring(0,r):i>0?e.substring(i+a):e)}else e.key.length&&t.push(e.key)})),t=(t=t.join(",")).indexOf(".")<0?t.replace(/\,/g,"."):t):t=e.key,t},e.prototype._addToResult=function(e,t,n,r){var i=this._stringValueOfKey(r.path),a=this._stringValueOfKey(t),s=n.result[i],o=!1;if(s||(n.result[i]={}),s){var u=s[a];n.temp&&n.temp[a]?(s[a]=[s[a]],delete n.temp):u&&u instanceof Array==!1&&(n.result[i][a]=[u],s=n.result[i]),e=this._normalize(e,r.deepXml),s[a]?"object"==typeof e?JSON.stringify(e)!==JSON.stringify(s[a][0])&&s[a].push(e[a]?e[a]:e):s[a].push(e[a]?e[a]:e):s instanceof Array==!1?(n.result[i]=[s],n.result[i].push(e[a]?e[a]:e)):"object"==typeof e?JSON.stringify(e)!==JSON.stringify(s[0])&&s.push(e[a]?e[a]:e):s.push(e[a]?e[a]:e)}else e instanceof Array&&(n.temp||(n.temp={}),n.temp[a]||(n.temp[a]=!0)),n.result[i][a]=this._normalize(e,r.deepXml),o=!0;return o},e.prototype._pack=function(e){var t=this;if(e instanceof Array){var n=[];e.map((function(e){n.push(t._pack(e))})),e=n}else if("object"==typeof e){Object.keys(e).map((function(t){var n=e[t];n instanceof Array||n[t]&&(e[t]=n[t])}))}return e},e.prototype._triggerResult=function(e,t,n){var r,i=this._pack(n);return t&&("string"==typeof t?(r={})[t]=i:"object"==typeof t&&(r=t)),e.next(i),r},e.prototype._subquery=function(e,t,n,r){var a=this;void 0===n.cachedFiles[t]&&(n.cachedFiles[t]=new i.BehaviorSubject(null),this._queryIteration(n.cachedFiles[t],n,{path:r.path,in:r.in,deepXml:r.deepXml,join:r.join,handler:r.handler,queryItems:r.path instanceof Array?r.path.length:1},t)),n.cachedFiles[t].subscribe((function(t){if(t){var i=r.join?r.join[r.path]:void 0;i?t instanceof Array?t.map((function(t){a._subquery(e,t,n,{path:i.path,in:null==i.in?r.in:i.in+t,deepXml:i.deepXml,join:i.join,handler:i.handler,queryItems:i.path instanceof Array?i.path.length:1})})):a._subquery(e,t,n,{path:r.join[i.path],in:null==i.in?r.in:i.in+t,deepXml:r.deepXml,join:i.join,handler:i.handler,queryItems:i.path instanceof Array?i.path.length:1}):a._addToResult(t,r.path,n,r)?(r.queryItems--,0===r.queryItems&&(n.as=a._triggerResult(e,n.as,n.result))):(r.queryItems--,n.as=a._triggerResult(e,n.as,n.result))}}),(function(t){a.logEnabled&&console.log(t),r.queryItems--,n.as=a._triggerResult(e,n.as,n.result)}))},e.prototype._queryIteration=function(e,t,n,r){var i=this;n.handler||(n.handler=function(e,t,n){return n}),this._select(n.path,n.in,n.deepXml,t.as,n.handler).subscribe((function(a){if(a)if(r)t.cachedFiles[r].next(a);else if(a instanceof Array){var s=n.join?n.join[n.path]:void 0;if(s)a.map((function(r){var a=r["#text"]?r["#text"]:r,o=s.path instanceof Array?s.path.length:1;null==s.in&&(t.cachedFiles[a]=i._select(s.path,n.in,s.deepXml,t.as,s.handler),o--),i._subquery(e,a,t,{path:s.path,in:null==s.in?n.in:s.in+r,deepXml:s.deepXml,join:s.join,handler:s.handler,queryItems:o})}));else if(n.queryItems--,0===n.queryItems){t.result&&t.result;t.as=i._triggerResult(e,t.as,Object.keys(t.result).length?t.result:a)}}else"object"==typeof a?Object.keys(a).map((function(r){var s=a[r],o=n.join?n.join[r]:void 0;if(s&&s.length&&o){var u=o.path instanceof Array?o.path.length:1;null==o.in&&(t.cachedFiles[s]=i._select(o.path,n.in,o.deepXml,t.as,o.handler),u--),i._subquery(e,s,t,{path:o.path,in:null==o.in?n.in:o.in+s,deepXml:o.deepXml,handler:o.handler,queryItems:u})}else n.queryItems--,s&&(t.result||(t.result={}),t.result instanceof Array?t.result.push(s):t.result[r]=s),0===n.queryItems&&(t.as=i._triggerResult(e,t.as,Object.keys(t.result).length?t.result:a))})):(n.queryItems--,0===n.queryItems&&0===Object.keys(t.result).length&&void 0!==a&&(t.result=a),t.as=i._triggerResult(e,t.as,t.result))}),(function(r){e.error({message:"failed to query "+n.path,reason:r.message?r.message:r}),n.queryItems--,0===n.queryItems&&(t.as=i._triggerResult(e,t.as,t.result))}))},e.prototype._makeArguments=function(e){var t=this,n=e.split("."),r=[];return n.map((function(e){var n=e.indexOf("[");if(n<0)r.push({key:e,validated:[function(e,t){return!0}]});else{var i=e.substring(n+1,e.length-1).split("]["),a={key:e.substring(0,n),validated:[function(e,t){return!0}]};i.map((function(e){if((e=(e=e.replace(/\`/g,".")).replace(/\@/g,"data")).indexOf("order-by:")>-1){var n=e.substring(e.indexOf("order-by:")+10).trim().split("~"),r=n[0].trim(),i=n[1]?n[1].trim().toLowerCase():"asc";a.sort=function(e){var t=function(e,t){return e.split(".").map((function(e){t=t[e]})),t};return e.sort((function(e,n){return t(r,e)>t(r,n)?"asc"===i?1:-1:"asc"===i?-1:1}))}}else{var s=e.indexOf("&&")>0||e.indexOf("||")>0,o="return function (data, asList) { \n";o+=t._globalFunctions(),o+="var x = false;\n try{\n x = ",o+=(s?"("+e+")":e)+"; \n}catch(e){}\n return x;\n}",a.validated.push(new Function(o)())}})),r.push(a)}})),r},e.prototype._handleSpecialCharacters=function(e){var t=[];return e.split("]").map((function(e){var n=e.indexOf("[");if(n>=0){var r="";n>0&&(r+=e.substring(0,n)),r+=e.substring(n).replace(/\./g,"`"),t.push(r)}else t.push(e)})),t.join("]")},e.prototype._prepareJsonPath=function(e){var t,n=this;if(e instanceof Array)t=[],e.map((function(e){var r=n._handleSpecialCharacters(e);t.push(n._makeArguments(r))}));else{var r=this._handleSpecialCharacters(e);t=this._makeArguments(r)}return t},e.prototype._select=function(e,t,n,r,a){var s=this,o=new i.BehaviorSubject(null);return this._get(t).subscribe((function(t){var i,u=s._prepareJsonPath(e);a||(a=function(e,t,n){return n}),e instanceof Array?(i={},u.map((function(e){var o=s._valueOfJsonPath(e,t,r,n,a);if(o){var u=s._stringValueOfKey(e);i[u]=o}})),0===Object.keys(i).length&&(i=void 0)):"string"==typeof e&&(i=s._valueOfJsonPath(u,t,r,n,a)),i?o.next(i):o.error("Result not found for "+e)}),(function(e){o.error(e)})),o},e.prototype._xml2json=function(e){try{var t={};if(e.attributes)for(var n=e.attributes,r=0;r<n.length;r++){var i=n[r];t[i.name]=i.value}if(e.childNodes&&e.childNodes.length)for(r=0;r<e.childNodes.length;r++){var a=e.childNodes[r],s=a.nodeName;if(void 0===t[s]){(u=this._xml2json(a))&&(t[s]=u)}else{if(void 0===t[s].push){var o=t[s];t[s]=[],t[s].push(o)}var u;(u=this._xml2json(a))&&t[s].push(u)}}else{var l=e.textContent.trim().replace(/(?:\r\n|\r|\n|\t)/g,"");t=l.length?l:void 0}return t}catch(e){this.logEnabled&&console.log(e.message)}},e.prototype.chainSelect=function(e){var t=e.path instanceof Array?e.path.length:1,n={cachedFiles:{},as:{},result:{}},r=new i.BehaviorSubject(null);return n.cachedFiles[e.path]=r,this._queryIteration(r,n,{path:e.path,in:e.in,deepXml:e.deepXml,join:e.join,handler:e.handler,queryItems:t}),r},e.prototype.arraySelect=function(e,t){var n=this,r={};e.map((function(e){void 0===r[e.in]&&(r[e.in]=[]),r[e.in].push({path:e.path,deepXml:e.deepXml})}));var a=new i.BehaviorSubject(null);return Object.keys(r).map((function(e){n._select(r[e].path,e,r[e].deepXml,void 0,t).subscribe((function(e){e&&a.next(e)}),(function(e){a.error(e)}))})),a},e.prototype.select=function(e,t,n,r){return this._select(e,t,n,void 0,r)},e.ctorParameters=function(){return[{type:n.HttpClient}]},e=o([t.Injectable()],e)}(),l=function(){function e(e){this.queryService=e}return Object.defineProperty(e.prototype,"queryInfo",{set:function(e){var t=this;this.query=e,this.query?(this.selectedDocumentName=this.query.in.substring(this.query.in.lastIndexOf("/")),this.queryService.chainSelect({in:this.query.in,path:""}).subscribe((function(e){e&&(t.source=e,t.data=void 0)}),(function(e){t.source=e,t.data=void 0}))):(this.data=void 0,this.source=void 0)},enumerable:!0,configurable:!0}),e.prototype.parseFunctions=function(e){var t=this;e instanceof Array?e.map((function(e){t.parseFunctions(e)})):"object"==typeof e&&Object.keys(e).map((function(n){"handler"===n?e[n]=new Function("return function"+e[n])():t.parseFunctions(e[n])}))},e.prototype.executeQuery=function(e){var t=this;try{var n=JSON.parse(e.value);this.parseFunctions(n),n instanceof Array?this.queryService.arraySelect(n).subscribe((function(e){e&&(t.data=e)}),(function(e){t.data={alert:e}})):this.queryService.chainSelect(n).subscribe((function(e){e&&(t.data=e)}),(function(e){t.data={alert:e}}))}catch(e){this.data={alert:e.message}}},e.ctorParameters=function(){return[{type:u}]},o([t.Input()],e.prototype,"queryInfo",null),e=o([t.Component({selector:"wizard-query",template:'\n<div class="entry" *ngIf="source">\n  <div class="entry-label">Source: {{selectedDocumentName}}</div>\n  <div class="entry-label">Type or modify query</div>\n  <div class="entry-json">{{ source | json }}</div>\n  <textarea #text [value]="query | json" (input)="data = undefined"></textarea>\n  <div class="submit"><button (click)="executeQuery(text)">Execute query</button></div>\n</div>\n\n<div *ngIf="data" class="result-json">{{ data | json }}</div>\n',styles:[".result-json{border:1px solid #633;background-color:#fefefe;border-radius:5px;box-sizing:border-box;display:block;max-height:222px;min-height:222px;overflow-y:auto;position:relative;font-family:monospace;float:left;padding:5px;unicode-bidi:embed;width:100%;white-space:pre-wrap}.entry .entry-json{border:1px solid #633;background-color:#fefefe;box-sizing:border-box;display:block;max-height:222px;min-height:222px;overflow-y:auto;position:relative;font-family:monospace;float:left;padding:5px;unicode-bidi:embed;width:50%;white-space:pre-wrap;border-radius:0 0 0 5px}.entry textarea{width:50%;min-height:222px;max-height:222px;resize:none;box-sizing:border-box;padding:5px;border-radius:0 0 5px}.entry .entry-label{width:50%;font-weight:700;padding:5px;background-color:#888;color:#fff;float:left;box-sizing:border-box}.entry .submit{text-align:center;padding-bottom:5px}.entry .submit button{padding:5px 35px}"]})],e)}(),c=function(){function e(e){this.queryService=e,this.onQueryResult=new t.EventEmitter,this.onQueryError=new t.EventEmitter}return Object.defineProperty(e.prototype,"wizardQuery",{set:function(e){var t=this;this.query=e,this.query?this.query instanceof Array?this.queryService.arraySelect(this.query).subscribe((function(e){e&&t.onQueryResult.emit(e)}),(function(e){t.onQueryResult.emit({alert:e})})):this.queryService.chainSelect(this.query).subscribe((function(e){e&&t.onQueryResult.emit(e)}),(function(e){t.onQueryResult.emit({alert:e})})):this.onQueryResult.emit(void 0)},enumerable:!0,configurable:!0}),e.ctorParameters=function(){return[{type:u}]},o([t.Output()],e.prototype,"onQueryResult",void 0),o([t.Output()],e.prototype,"onQueryError",void 0),o([t.Input()],e.prototype,"wizardQuery",null),e=o([t.Directive({selector:"[wizardQuery]"})],e)}(),p=function(){function e(){}return e=o([t.NgModule({declarations:[l,c],exports:[l,c],imports:[s.CommonModule,n.HttpClientModule],providers:[u],schemas:[t.CUSTOM_ELEMENTS_SCHEMA]})],e)}();e.WizardQueryComponent=l,e.WizardQueryDirective=c,e.WizardQueryModule=p,e.WizardQueryService=u,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=sedeh-wizard-query.umd.min.js.map